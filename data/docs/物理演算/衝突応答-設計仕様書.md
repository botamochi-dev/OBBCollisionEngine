# 3D SAT 衝突応答：計算手順書

## 0. 前提と記法
- オブジェクト A：クォータニオン回転可・動的、質量 `m`、ローカル慣性テンソル `I_body`。
- オブジェクト B：静的（無限質量・角速度 0）。
- 座標系はワールド座標。  
- `A_q`：A の回転（クォータニオン→3×3 行列）。  
- `A_pos`, `B_pos`：重心位置ベクトル。  
- `v`, `ω`：A の線形速度・角速度。  
- `Δt`：1 ステップの時間幅。

## 1. 入力取得
1. A の頂点をローカル座標から `A_q` と `A_pos` でワールド座標へ変換。  
2. B は回転しないため頂点は平行移動のみ。  
3. A・B の局所軸（A: `A_q` の列ベクトル、B: ワールド軸）を用意。

## 2. SAT による交差判定
1. 候補軸 15 本  
   - A の 3 軸 `a_i`  
   - B の 3 軸 `b_j`  
   - 外積軸 `a_i × b_j`（正規化可能な場合のみ）  
2. 各軸 `n_candidate` に対して：
   - A・B の頂点を投影しスカラー最小値 `min`, 最大値 `max` を求める。  
   - 区間が分離する軸があれば `collision = false` で終了。  
3. すべて重なっていれば `collision = true`。  
   - 重なり量 `overlap = min(maxA, maxB) - max(minA, minB)`。  
   - 最小の `overlap` を持つ軸を記録（符号を調整して A→B を向く `n`）。

## 3. 最小移動ベクトル (MTV)
- `penetration = overlap_min`  
- `mtv = penetration * n`  
- B は固定なので後で `A_pos ← A_pos + mtv` で貫入を除去。

## 4. 接触点抽出（簡易）
1. MTV 軸に垂直な面を判定し、A の「侵入面」か B の「受け面」を選ぶ。  
2. 片方の面頂点集合をもう一方の面の半空間でクリップし、多角形を得る。  
3. 得られた頂点群 `{c_k}` を接触点候補とする。  
   - 簡易化したい場合は MTV 軸方向に最も突き出した A の頂点を単一点とする。

## 5. 相対速度の計算
各接触点 `c_k` について：
1. `r = c_k - A_pos`  
2. 接触点速度  
   - `v_c = v + ω × r`  
3. 法線方向相対速度  
   - `v_rel = dot(v_c, n)`  
4. `v_rel ≥ 0`（離反）なら処理をスキップ。

## 6. インパルス量の算出
1. 慣性テンソルをワールドへ変換  
   - `I_world = A_q * I_body * A_qᵀ`  
   - 逆行列 `I_world_inv` を求める。  
2. 中間量  
   - `k = I_world_inv * (r × n)`  
   - `denom = (1 / m) + dot(n, k × r)`  
3. 法線インパルス（反発なし）  
   - `J = -v_rel / denom`  
4. 必要なら反発係数 `e` を加味：`J = -(1 + e) * v_rel / denom`。

## 7. 速度・角速度の更新
- `v ← v + (J / m) * n`  
- `ω ← ω + I_world_inv * (r × (J * n))`

## 8. 位置補正
- `A_pos ← A_pos + β * mtv` （β∈[0,1]、例：β=1 で完全補正）  
- 数値安定化のためバウムガルテ補正なら `β = penetration_correction_rate / Δt` を採用。

## 9. 姿勢更新
1. 角速度からクォータニオン更新  
   - 角速度微小回転 `Δq = [0, ω] * q * 0.5 * Δt` を用いて  
     `q ← normalize(q + Δq)`  
2. 線形速度で位置積分  
   - `A_pos ← A_pos + v * Δt`

## 10. ループ構造
1. 予測積分（半ステップ）→ SAT 判定 → 衝突応答（6–8）→ 最終積分（9）  
2. 複数接触点がある場合は各点で `J` を計算し合計。  
3. 深い貫入や連続衝突には TOI 解法やサブステップを追加する。

---
本手順は物性値（反発・摩擦）を省いた最小構成です。摩擦を扱う場合は法線に直交する接線ベクトルを構成し、同様の式で接線インパルスを計算してください。